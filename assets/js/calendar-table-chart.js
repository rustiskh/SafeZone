const dataTable = [
    {
        created_at: "2024-03-02 16:49:00",
        name: "08474",
        ref_link: "https:\/\/szmarket.ru\/r\/08474",
        ref_link_id: '1',
        all_clicks: 2,
        all_members: 1,
        all_transactions: 0,
        all_transactions_sum: 0
    },
    {
        created_at: "2024-03-14 16:33:25",
        name: "474b749e50",
        ref_link: "https:\/\/szmarket.ru\/r\/474b749e50",
        ref_link_id: '12',
        all_clicks: 0,
        all_members: 0,
        all_transactions: 0,
        all_transactions_sum: 0
    },
    {
        created_at: "2024-03-11 16:30:00",
        name: "e8feeb9224",
        ref_link: "https:\/\/szmarket.ru\/r\/e8feeb9224",
        ref_link_id: '121',
        all_clicks: 0,
        all_members: 0,
        all_transactions: 0,
        all_transactions_sum: 0
    },
    {
        created_at: "2024-03-08 16:25:10",
        name: "818ae98db2",
        ref_link: "https:\/\/szmarket.ru\/r\/818ae98db2",
        ref_link_id: '1211',
        all_clicks: 0,
        all_members: 0,
        all_transactions: 0,
        all_transactions_sum: 0
    },
    {
        created_at: "2024-03-04 16:22:55",
        name: "7df5c27f2e",
        ref_link: "https:\/\/szmarket.ru\/r\/7df5c27f2e",
        ref_link_id: '122',
        all_clicks: 0,
        all_members: 0,
        all_transactions: 0,
        all_transactions_sum: 0
    }
]

const detailedDatabase = {
    "1": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "4",
            },
            {
                created_at: "2024-03-06",
                sum: "5",
            },
            {
                created_at: "2024-03-07",
                sum: "10",
            },
            {
                created_at: "2024-03-08",
                sum: "20",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "40",
            },
            {
                created_at: "2024-03-06",
                sum: "55",
            },
            {
                created_at: "2024-03-07",
                sum: "13",
            },
            {
                created_at: "2024-03-08",
                sum: "25",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "44",
            },
            {
                created_at: "2024-03-06",
                sum: "55",
            },
            {
                created_at: "2024-03-07",
                sum: "103",
            },
            {
                created_at: "2024-03-08",
                sum: "20",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "2",
            },
            {
                created_at: "2024-03-06",
                sum: "3",
            },
            {
                created_at: "2024-03-07",
                sum: "19",
            },
            {
                created_at: "2024-03-08",
                sum: "5",
            },
        ]
    },
    "12": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "6",
            },
            {
                created_at: "2024-03-06",
                sum: "3",
            },
            {
                created_at: "2024-03-07",
                sum: "4",
            },
            {
                created_at: "2024-03-08",
                sum: "21",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "75",
            },
            {
                created_at: "2024-03-06",
                sum: "75",
            },
            {
                created_at: "2024-03-07",
                sum: "34",
            },
            {
                created_at: "2024-03-08",
                sum: "73",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "25",
            },
            {
                created_at: "2024-03-06",
                sum: "86",
            },
            {
                created_at: "2024-03-07",
                sum: "64",
            },
            {
                created_at: "2024-03-08",
                sum: "35",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "9",
            },
            {
                created_at: "2024-03-06",
                sum: "5",
            },
            {
                created_at: "2024-03-07",
                sum: "7",
            },
            {
                created_at: "2024-03-08",
                sum: "4",
            },
        ]
    },
    "121": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "5",
            },
            {
                created_at: "2024-03-06",
                sum: "7",
            },
            {
                created_at: "2024-03-07",
                sum: "5",
            },
            {
                created_at: "2024-03-08",
                sum: "6",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "78",
            },
            {
                created_at: "2024-03-06",
                sum: "65",
            },
            {
                created_at: "2024-03-07",
                sum: "45",
            },
            {
                created_at: "2024-03-08",
                sum: "77",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "46",
            },
            {
                created_at: "2024-03-06",
                sum: "58",
            },
            {
                created_at: "2024-03-07",
                sum: "36",
            },
            {
                created_at: "2024-03-08",
                sum: "77",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "22",
            },
            {
                created_at: "2024-03-06",
                sum: "77",
            },
            {
                created_at: "2024-03-07",
                sum: "88",
            },
            {
                created_at: "2024-03-08",
                sum: "22",
            },
        ]
    },
    "1211": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "9",
            },
            {
                created_at: "2024-03-06",
                sum: "8",
            },
            {
                created_at: "2024-03-07",
                sum: "8",
            },
            {
                created_at: "2024-03-08",
                sum: "4",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "58",
            },
            {
                created_at: "2024-03-06",
                sum: "55",
            },
            {
                created_at: "2024-03-07",
                sum: "77",
            },
            {
                created_at: "2024-03-08",
                sum: "55",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "36",
            },
            {
                created_at: "2024-03-06",
                sum: "58",
            },
            {
                created_at: "2024-03-07",
                sum: "22",
            },
            {
                created_at: "2024-03-08",
                sum: "25",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "36",
            },
            {
                created_at: "2024-03-06",
                sum: "38",
            },
            {
                created_at: "2024-03-07",
                sum: "88",
            },
            {
                created_at: "2024-03-08",
                sum: "25",
            },
        ]
    },
    "122": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "5",
            },
            {
                created_at: "2024-03-06",
                sum: "9",
            },
            {
                created_at: "2024-03-07",
                sum: "3",
            },
            {
                created_at: "2024-03-08",
                sum: "5",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "83",
            },
            {
                created_at: "2024-03-06",
                sum: "69",
            },
            {
                created_at: "2024-03-07",
                sum: "55",
            },
            {
                created_at: "2024-03-08",
                sum: "39",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "38",
            },
            {
                created_at: "2024-03-06",
                sum: "29",
            },
            {
                created_at: "2024-03-07",
                sum: "39",
            },
            {
                created_at: "2024-03-08",
                sum: "29",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "25",
            },
            {
                created_at: "2024-03-06",
                sum: "35",
            },
            {
                created_at: "2024-03-07",
                sum: "36",
            },
            {
                created_at: "2024-03-08",
                sum: "85",
            },
        ]
    }
}

window.addEventListener("DOMContentLoaded", () => {
    // Формат даты - используется в календаре, в графике и таблице для отображения и фильтрации при изменении
    const dateFormat = "Y-m-d";

    // Эта функция нужна для форматирования диапазона дат перед передачей в таблицу и график - она унифицирует все значения дат 
    function formatDate(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Функция вызова модалки редактирования 
    function showEditModal(element) {
        element.addEventListener('click', () => {
            console.log('Открываем модалку редактирования');
        })
    }

    // Получаем контейнер с графиком
    const graphContainer = document.getElementById('graph-container')
    // Получаем кнопки-табы
    const dataSet1 = document.getElementById("testData1");
    const tabDataSum1 = document.getElementById('dataSum-1');
    const dataSet2 = document.getElementById("testData2");
    const tabDataSum2 = document.getElementById('dataSum-2');
    const dataSet3 = document.getElementById("testData3");
    const tabDataSum3 = document.getElementById('dataSum-3');
    const dataSet4 = document.getElementById("testData4");
    const tabDataSum4 = document.getElementById('dataSum-4');

    // Ф-ция суммирования значений Детальных данных для вывода в табы
    function getTotalDetailedSum(array) {
        return array.reduce((accumulator, currentValue) => {
            let numericValue = parseFloat(currentValue.sum); // Преобразование строки в число
            if (!isNaN(numericValue)) { // Проверка на успешное преобразование
                accumulator += numericValue;
            }
            return accumulator;
        }, 0);
    }


    function showGraph(element, link_id) {
        element.addEventListener('click', () => {
            console.log('Открываем блок графика');
            graphContainer.style.display = "block";

            // Получаем и вставляем суммарные данные в табы графика
            tabDataSum1.innerHTML = getTotalDetailedSum(detailedDatabase[link_id].dataComission);
            tabDataSum2.innerHTML = getTotalDetailedSum(detailedDatabase[link_id].dataClicks);
            tabDataSum3.innerHTML = getTotalDetailedSum(detailedDatabase[link_id].dataReferals);
            tabDataSum4.innerHTML = getTotalDetailedSum(detailedDatabase[link_id].dataTransactions);

            // Добавляем в табы дата атрибут с ключом 
            dataSet1.setAttribute("data-current-link_id", link_id);
            dataSet2.setAttribute("data-current-link_id", link_id);
            dataSet3.setAttribute("data-current-link_id", link_id);
            dataSet4.setAttribute("data-current-link_id", link_id);

            // Отрисовка графика при открытии блок по клику на Подробнее в таблице
            setDataset(detailedDatabase[link_id].dataComission)
            dataSet1.classList.add('active')
        })
    }

    function toggleActiveClass(event) {
        // Получаем элемент, на котором произошло событие клика
        const clickedElement = event.target;

        // Получаем все кнопки в массиве
        const buttons = [dataSet1, dataSet2, dataSet3, dataSet4];

        // Проходимся по всем кнопкам
        buttons.forEach(button => {
            // Если текущая кнопка совпадает с кнопкой, на которую кликнули
            if (button === clickedElement) {
                // Добавляем класс "active"
                button.classList.add("active");
            } else {
                // Иначе удаляем класс "active"
                button.classList.remove("active");
            }
        });
    }


    // Функция копирования данных
    // Копирование - Это дублирующий функционал (он ещё встречается в промокодах на страницах игр) 
    let activeCopyIcon;
    function copyData(element) {
        element.addEventListener('click', () => {
            navigator.clipboard.writeText(element.parentNode.childNodes[0].textContent).then(
                element.classList.add('promocode__copy_active')
            );
        });

        const onChangeActiveIcon = (item) => {
            if (activeCopyIcon) {
                activeCopyIcon.classList.remove('promocode__copy_active');
            }
            activeCopyIcon = item;
            item.classList.add('promocode__copy_active');
        }

        element.addEventListener('click', ({ currentTarget }) => {
            onChangeActiveIcon(currentTarget);
        })
    }

    // Получение данных для таблицы и создание строк
    // Получаем ссылку на тело таблицы
    const tableBody = document.querySelector("#dataTable tbody");

    // Формирование строк таблицы из массива dataTable
    dataTable.forEach(data => {
        // Строка таблицы
        const row = document.createElement("tr");

        // Содержимое ячейки
        for (const prop in data) {
            const cell = document.createElement("td");
            cell.textContent = data[prop];

            // Добавление ячейки с ссылкой классов для рендера кнопок редактирвоания и копирования. Навесил на 2 разных класса на всякий случай
            if (prop === "ref_link") {
                cell.classList.add("edit", "copy", "detail");

                if (cell.classList.contains("copy")) {
                    const copyBtn = document.createElement("div");
                    copyBtn.classList.add("copy-btn");
                    copyBtn.innerHTML =
                        '<svg svg width="26" height="30" viewBox="0 0 26 30" fill="none" xmlns="http://www.w3.org/2000/svg" >' +
                        '<path d="M3.00196 30C2.17696 30 1.47046 29.706 0.882455 29.118C0.294455 28.53 0.000955672 27.824 0.00195567 27V6H3.00196V27H19.502V30H3.00196ZM9.00196 24C8.17696 24 7.47046 23.706 6.88246 23.118C6.29446 22.53 6.00096 21.824 6.00196 21V3C6.00196 2.175 6.29596 1.4685 6.88396 0.880502C7.47196 0.292502 8.17796 -0.000997453 9.00196 2.54669e-06H22.502C23.327 2.54669e-06 24.0335 0.294003 24.6215 0.882003C25.2095 1.47 25.503 2.176 25.502 3V21C25.502 21.825 25.208 22.5315 24.62 23.1195C24.032 23.7075 23.326 24.001 22.502 24H9.00196ZM9.00196 21H22.502V3H9.00196V21Z" fill="white" />' +
                        '</svg >';
                    cell.appendChild(copyBtn);
                    // Помещено сюда на случай задержки при получении данных для построения таблицы
                    copyData(copyBtn);
                }

                if (cell.classList.contains("edit")) {
                    const editBtn = document.createElement("button");
                    editBtn.classList.add("edit-btn");
                    editBtn.innerHTML = "Ред.";
                    cell.appendChild(editBtn);
                    // Помещено сюда на случай задержки при получении данных для построения таблицы
                    showEditModal(editBtn);
                }

                if (cell.classList.contains("detail")) {
                    const detailBtn = document.createElement("button");
                    detailBtn.classList.add("detail-btn");
                    // Добавляем к каждой кнопке дата-атрибут для дальнейшего использования в запросах
                    detailBtn.setAttribute("data-link-id", data.ref_link_id)
                    detailBtn.innerHTML = "Подробнее";
                    cell.appendChild(detailBtn);
                    showGraph(detailBtn, data.ref_link_id);
                }
            }

            row.appendChild(cell);
        }

        // Пушим строку в тело таблицы
        tableBody.appendChild(row);
    });


    let table = new DataTable('#dataTable', {
        // options
        info: false,
        autoWidth: true,
        // scrollX: true,
        // Оставлю здесь, чтобы не потерять - для работы с сервером - https://datatables.net/reference/option/serverSide
        // Сама дока опций библиотеки https://datatables.net/reference/option/

        language: {
            "decimal": "",
            "emptyTable": "Нет данных",
            "thousands": ",",
            "lengthMenu": "Строк на странице _MENU_",
            "loadingRecords": "Загрузка...",
            "processing": "",
            "search": "Поиск:",
            "zeroRecords": "Нет данных, удовлетворяющих указанным параметрам",
            "paginate": {
                "first": "Первая",
                "last": "Последняя",
                "next": "Следующая",
                "previous": "Предыдущая"
            },
            "aria": {
                "orderable": "Упорядочить",
                "orderableReverse": "В обратном порядке"
            }
        }
    });

    function filterTableByCalendar(selectedDates) {
        let startDate = "";
        let endDate = "";

        if (selectedDates.length === 2) {
            startDate = formatDate(selectedDates[0], dateFormat);
            endDate = formatDate(selectedDates[1], dateFormat);
        } else if (selectedDates.length === 1) {
            // если выбрана только 1 дата, а не диапазон
            startDate = endDate = formatDate(selectedDates[0], dateFormat);
        }

        // console.log("Выбранный диапазон дат: ", startDate, " — ", endDate);

        table.column(0).search(function (value, index, data) {
            const date = new Date(value.split(' ')[0]);
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            return date >= startDateObj && date <= endDateObj;
        }).draw();
    }

    let tableCalendar = flatpickr("#calendar-1", {
        "mode": "range",
        "locale": "ru",
        defaultDate: [new Date().fp_incr(-24), new Date().fp_incr(-1)], // Дата по умолчанию предыдущие 2 недели
        dateFormat: dateFormat, // Формат даты
        onChange: function (selectedDates) {
            filterTableByCalendar(selectedDates);
        },
        onReady: function (selectedDates) {
            filterTableByCalendar(selectedDates);
        },
    });

    // График
    // Инициализация
    let myChart;
    const ctx = document.getElementById('myChart').getContext('2d');
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Sum',
                data: [],
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    offset: true
                },
                y: {
                    beginAtZero: true
                }
            },
            elements: {
                line: {
                    // Кривизна графика, если не нужна удалить elements или скорректировать tension
                    tension: 0.3
                }
            }
        },
    });

    // // Помещаем данные из выбранного датасета
    function handleDataSetClick(dataType) {
        return ({ currentTarget }) => {
            const currentId = currentTarget.getAttribute("data-current-link_id");
            switch (dataType) {
                case 'comission':
                    setDataset(detailedDatabase[currentId].dataComission);
                    break;
                case 'clicks':
                    setDataset(detailedDatabase[currentId].dataClicks);
                    break;
                case 'referals':
                    setDataset(detailedDatabase[currentId].dataReferals);
                    break;
                case 'transactions':
                    setDataset(detailedDatabase[currentId].dataTransactions);
                    break;
                default:
                    console.error("Неверный тип данных");
            }
        };
    }

    dataSet1.addEventListener('click', (event) => {
        toggleActiveClass(event);
        handleDataSetClick('comission')(event);
    });
    dataSet2.addEventListener('click', (event) => {
        toggleActiveClass(event);
        handleDataSetClick('clicks')(event);
    });
    dataSet3.addEventListener('click', (event) => {
        toggleActiveClass(event);
        handleDataSetClick('referals')(event);
    });
    dataSet4.addEventListener('click', (event) => {
        toggleActiveClass(event);
        handleDataSetClick('transactions')(event);
    });

    function setDataset(dataset) {
        const labels = dataset.map(data => data.created_at);
        const data = dataset.map(data => parseInt(data.sum))

        myChart.data.labels = labels;
        myChart.data.datasets[0].data = data;
        myChart.update();
        // return { labels, data };
    }



    // Календарь для графика
    let chartCalendar = flatpickr("#calendar-chart", {
        "mode": "range",
        "locale": "ru",
        defaultDate: [new Date().fp_incr(-24), new Date().fp_incr(-1)], // Дата по умолчанию предыдущие 2 недели
        dateFormat: dateFormat, // Формат даты

        onChange: function (selectedDates) {
            const currentId = dataSet1.getAttribute("data-current-link_id");
            updateChartData(selectedDates, currentId)
        },
        onReady: function (selectedDates) {
            const currentId = dataSet1.getAttribute("data-current-link_id");
            updateChartData(selectedDates, currentId)
        },
    });

    // Функция для обновления данных графика

    function updateChartData(selectedDates, currentId) {
        let startDate = "";
        let endDate = "";

        if (selectedDates.length === 2) {
            startDate = formatDate(selectedDates[0], dateFormat);
            endDate = formatDate(selectedDates[1], dateFormat);
        } else if (selectedDates.length === 1) {
            // Если выбрана только 1 дата, а не диапазон
            startDate = formatDate(selectedDates[0], dateFormat);
            endDate = formatDate(selectedDates[0], dateFormat); // Используем одну и ту же дату для начала и конца диапазона
        }

        // Фильтруем данные для каждого типа информации
        const dataTypes = ['dataComission', 'dataClicks', 'dataReferals', 'dataTransactions'];

        dataTypes.forEach(type => {
            const filteredData = detailedDatabase[currentId][type].filter(data => {
                const date = new Date(data.created_at);
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                return date >= startDateObj && date <= endDateObj;
            });

            myChart.data.labels = filteredData.map(data => data.created_at);
            myChart.data.datasets[0].data = filteredData.map(data => parseInt(data.sum));
        });

        myChart.update();
    }
})

















// const detailedDatabase = [
//     {
//         ref_link_id: "1",
//         dataComission: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "4",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "5",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "10",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "20",
//             },
//         ],
//         dataClicks: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "40",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "55",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "13",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "25",
//             },
//         ],
//         dataReferals: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "44",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "55",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "103",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "20",
//             },
//         ],
//         dataTransactions: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "2",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "3",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "19",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "5",
//             },
//         ]
//     },
//     {
//         ref_link_id: "12",
//         dataComission: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "6",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "3",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "4",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "21",
//             },
//         ],
//         dataClicks: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "75",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "75",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "34",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "73",
//             },
//         ],
//         dataReferals: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "25",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "86",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "64",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "35",
//             },
//         ],
//         dataTransactions: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "9",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "5",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "7",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "4",
//             },
//         ]
//     },
//     {
//         ref_link_id: "121",
//         dataComission: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "5",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "7",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "5",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "6",
//             },
//         ],
//         dataClicks: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "78",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "65",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "45",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "77",
//             },
//         ],
//         dataReferals: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "46",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "58",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "36",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "77",
//             },
//         ],
//         dataTransactions: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "22",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "77",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "88",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "22",
//             },
//         ]
//     },
//     {
//         ref_link_id: "1211",
//         dataComission: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "9",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "8",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "8",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "4",
//             },
//         ],
//         dataClicks: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "58",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "55",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "77",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "55",
//             },
//         ],
//         dataReferals: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "36",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "58",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "22",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "25",
//             },
//         ],
//         dataTransactions: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "36",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "38",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "88",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "25",
//             },
//         ]
//     },
//     {
//         ref_link_id: "122",
//         dataComission: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "5",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "9",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "3",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "5",
//             },
//         ],
//         dataClicks: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "83",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "69",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "55",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "39",
//             },
//         ],
//         dataReferals: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "38",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "29",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "39",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "29",
//             },
//         ],
//         dataTransactions: [
//             {
//                 created_at: "2024-03-05",
//                 sum: "25",
//             },
//             {
//                 created_at: "2024-03-06",
//                 sum: "35",
//             },
//             {
//                 created_at: "2024-03-07",
//                 sum: "36",
//             },
//             {
//                 created_at: "2024-03-08",
//                 sum: "85",
//             },
//         ]
//     }
// ]

// window.addEventListener("DOMContentLoaded", () => {
//     console.log("Файл calendar-table-chart.js подключен");

//     // Формат даты - используется в календаре, в графике и таблице для отображения и фильтрации при изменении
//     const dateFormat = "Y-m-d";

//     // Эта функция нужна для форматирования диапазона дат перед передачей в таблицу и график - она унифицирует все значения дат
//     function formatDate(date) {
//         const year = date.getFullYear();
//         const month = (date.getMonth() + 1).toString().padStart(2, '0');
//         const day = date.getDate().toString().padStart(2, '0');
//         return `${year}-${month}-${day}`;
//     }

//     // Функция вызова модалки редактирования
//     function showEditModal(element) {
//         element.addEventListener('click', () => {
//             console.log('Открываем модалку редактирования');
//         })
//     }

//     // Получаем контейнер с графиком
//     const graphContainer = document.getElementById('graph-container')
//     // Получаем кнопки-табы
//     const dataSet1 = document.getElementById("testData1");
//     const tabDataSum1 = document.getElementById('dataSum-1');
//     const dataSet2 = document.getElementById("testData2");
//     const tabDataSum2 = document.getElementById('dataSum-2');
//     const dataSet3 = document.getElementById("testData3");
//     const tabDataSum3 = document.getElementById('dataSum-3');
//     const dataSet4 = document.getElementById("testData4");
//     const tabDataSum4 = document.getElementById('dataSum-4');

//     // Ф-ция суммирования значений Детальных данных для вывода в табы
//     function getTotalDetailedSum(array) {
//         return array.reduce((accumulator, currentValue) => {
//             let numericValue = parseFloat(currentValue.sum); // Преобразование строки в число
//             if (!isNaN(numericValue)) { // Проверка на успешное преобразование
//                 accumulator += numericValue;
//             }
//             return accumulator;
//         }, 0);
//     }


//     function showGraph(element, link_id) {
//         element.addEventListener('click', () => {
//             console.log('Открываем блок графика');
//             graphContainer.style.display = "block";

//             // Тут по идее вставляем ваш запрос на получение детальной информации
//             const filteredDetaliedData = detailedDatabase.find((element) => {
//                 return element.ref_link_id === link_id;
//             })


//             // Получаем суммарные данные в табы графика
//             const sumComission = getTotalDetailedSum(filteredDetaliedData.dataComission);
//             const sumClicks = getTotalDetailedSum(filteredDetaliedData.dataClicks);
//             const sumReferals = getTotalDetailedSum(filteredDetaliedData.dataReferals);
//             const sumTransactions = getTotalDetailedSum(filteredDetaliedData.dataTransactions);

//             // Вставляем суммарные данные в табы графика
//             tabDataSum1.innerHTML = sumComission;
//             tabDataSum2.innerHTML = sumClicks;
//             tabDataSum3.innerHTML = sumReferals;
//             tabDataSum4.innerHTML = sumTransactions;
//             dataSet1.setAttribute("data-current-link_id", link_id);
//             dataSet2.setAttribute("data-current-link_id", link_id);
//             dataSet3.setAttribute("data-current-link_id", link_id);
//             dataSet4.setAttribute("data-current-link_id", link_id);

//             // Отрисовка графика при открытии блок по клику на Подробнее в таблице
//             setDataset(filteredDetaliedData.dataComission)
//             tabDataSum1.classList.add('active')
//         })
//     }


//     // Функция копирования данных
//     // Копирование - Это дублирующий функционал (он ещё встречается в промокодах на страницах игр)
//     let activeCopyIcon;
//     function copyData(element) {
//         element.addEventListener('click', () => {
//             navigator.clipboard.writeText(element.parentNode.childNodes[0].textContent).then(
//                 element.classList.add('promocode__copy_active')
//             );
//         });

//         const onChangeActiveIcon = (item) => {
//             if (activeCopyIcon) {
//                 activeCopyIcon.classList.remove('promocode__copy_active');
//             }
//             activeCopyIcon = item;
//             item.classList.add('promocode__copy_active');
//         }

//         element.addEventListener('click', ({ currentTarget }) => {
//             onChangeActiveIcon(currentTarget);
//         })
//     }

//     // Получение данных для таблицы и создание строк
//     // Получаем ссылку на тело таблицы
//     const tableBody = document.querySelector("#dataTable tbody");

//     // Формирование строк таблицы из массива dataTable
//     dataTable.forEach(data => {
//         // Строка таблицы
//         const row = document.createElement("tr");

//         // Содержимое ячейки
//         for (const prop in data) {
//             const cell = document.createElement("td");
//             cell.textContent = data[prop];

//             // Добавление ячейки с ссылкой классов для рендера кнопок редактирвоания и копирования. Навесил на 2 разных класса на всякий случай
//             if (prop === "ref_link") {
//                 cell.classList.add("edit", "copy", "detail");

//                 if (cell.classList.contains("copy")) {
//                     const copyBtn = document.createElement("div");
//                     copyBtn.classList.add("copy-btn");
//                     copyBtn.innerHTML =
//                         '<svg svg width="26" height="30" viewBox="0 0 26 30" fill="none" xmlns="http://www.w3.org/2000/svg" >' +
//                         '<path d="M3.00196 30C2.17696 30 1.47046 29.706 0.882455 29.118C0.294455 28.53 0.000955672 27.824 0.00195567 27V6H3.00196V27H19.502V30H3.00196ZM9.00196 24C8.17696 24 7.47046 23.706 6.88246 23.118C6.29446 22.53 6.00096 21.824 6.00196 21V3C6.00196 2.175 6.29596 1.4685 6.88396 0.880502C7.47196 0.292502 8.17796 -0.000997453 9.00196 2.54669e-06H22.502C23.327 2.54669e-06 24.0335 0.294003 24.6215 0.882003C25.2095 1.47 25.503 2.176 25.502 3V21C25.502 21.825 25.208 22.5315 24.62 23.1195C24.032 23.7075 23.326 24.001 22.502 24H9.00196ZM9.00196 21H22.502V3H9.00196V21Z" fill="white" />' +
//                         '</svg >';
//                     cell.appendChild(copyBtn);
//                     // Помещено сюда на случай задержки при получении данных для построения таблицы
//                     copyData(copyBtn);
//                 }

//                 if (cell.classList.contains("edit")) {
//                     const editBtn = document.createElement("button");
//                     editBtn.classList.add("edit-btn");
//                     editBtn.innerHTML = "Ред.";
//                     cell.appendChild(editBtn);
//                     // Помещено сюда на случай задержки при получении данных для построения таблицы
//                     showEditModal(editBtn);
//                 }

//                 if (cell.classList.contains("detail")) {
//                     const detailBtn = document.createElement("button");
//                     detailBtn.classList.add("detail-btn");
//                     // Добавляем к каждой кнопке дата-атрибут для дальнейшего использования в запросах
//                     detailBtn.setAttribute("data-link-id", data.ref_link_id)
//                     detailBtn.innerHTML = "Подробнее";
//                     cell.appendChild(detailBtn);
//                     showGraph(detailBtn, data.ref_link_id);
//                 }
//             }

//             row.appendChild(cell);
//         }

//         // Пушим строку в тело таблицы
//         tableBody.appendChild(row);
//     });


//     let table = new DataTable('#dataTable', {
//         // options
//         info: false,
//         autoWidth: true,
//         // scrollX: true,
//         // Оставлю здесь, чтобы не потерять - для работы с сервером - https://datatables.net/reference/option/serverSide
//         // Сама дока опций библиотеки https://datatables.net/reference/option/

//         language: {
//             "decimal": "",
//             "emptyTable": "Нет данных",
//             "thousands": ",",
//             "lengthMenu": "Строк на странице _MENU_",
//             "loadingRecords": "Загрузка...",
//             "processing": "",
//             "search": "Поиск:",
//             "zeroRecords": "Нет данных, удовлетворяющих указанным параметрам",
//             "paginate": {
//                 "first": "Первая",
//                 "last": "Последняя",
//                 "next": "Следующая",
//                 "previous": "Предыдущая"
//             },
//             "aria": {
//                 "orderable": "Упорядочить",
//                 "orderableReverse": "В обратном порядке"
//             }
//         }
//     });

//     function filterTableByCalendar(selectedDates) {
//         let startDate = "";
//         let endDate = "";

//         if (selectedDates.length === 2) {
//             startDate = formatDate(selectedDates[0], dateFormat);
//             endDate = formatDate(selectedDates[1], dateFormat);
//         } else if (selectedDates.length === 1) {
//             // если выбрана только 1 дата, а не диапазон
//             startDate = endDate = formatDate(selectedDates[0], dateFormat);
//         }

//         // console.log("Выбранный диапазон дат: ", startDate, " — ", endDate);

//         table.column(0).search(function (value, index, data) {
//             const date = new Date(value.split(' ')[0]);
//             const startDateObj = new Date(startDate);
//             const endDateObj = new Date(endDate);
//             return date >= startDateObj && date <= endDateObj;
//         }).draw();
//     }

//     let tableCalendar = flatpickr("#calendar-1", {
//         "mode": "range",
//         "locale": "ru",
//         defaultDate: [new Date().fp_incr(-14), new Date().fp_incr(-1)], // Дата по умолчанию предыдущие 2 недели
//         dateFormat: dateFormat, // Формат даты
//         onChange: function (selectedDates) {
//             filterTableByCalendar(selectedDates);
//         },
//         onReady: function (selectedDates) {
//             filterTableByCalendar(selectedDates);
//         },
//     });

//     // График
//     // Инициализация
//     let myChart;
//     const ctx = document.getElementById('myChart').getContext('2d');
//     myChart = new Chart(ctx, {
//         type: 'line',
//         data: {
//             labels: [],
//             datasets: [{
//                 label: 'Sum',
//                 data: [],
//                 borderColor: 'rgba(255, 99, 132, 1)',
//                 borderWidth: 1
//             }]
//         },
//         options: {
//             scales: {
//                 x: {
//                     offset: true
//                 },
//                 y: {
//                     beginAtZero: true
//                 }
//             },
//             elements: {
//                 line: {
//                     // Кривизна графика, если не нужна удалить elements или скорректировать tension
//                     tension: 0.3
//                 }
//             }
//         },
//     });

//     // // Помещаем данные из выбранного датасета
//     function handleDataSetClick(dataType) {
//         return ({ currentTarget }) => {
//             const currentId = currentTarget.getAttribute("data-current-link_id");
//             const filteredDetaliedData = detailedDatabase.find((element) => {
//                 return element.ref_link_id === currentId;
//             });
//             switch (dataType) {
//                 case 'comission':
//                     setDataset(filteredDetaliedData.dataComission);
//                     updateChartData(filteredDetaliedData.dataComission);
//                     break;
//                 case 'clicks':
//                     setDataset(filteredDetaliedData.dataClicks);
//                     break;
//                 case 'referals':
//                     setDataset(filteredDetaliedData.dataReferals);
//                     break;
//                 case 'transactions':
//                     setDataset(filteredDetaliedData.dataTransactions);
//                     break;
//                 default:
//                     console.error("Неверный тип данных");
//             }
//         };
//     }

//     dataSet1.addEventListener('click', handleDataSetClick('comission'));
//     dataSet2.addEventListener('click', handleDataSetClick('clicks'));
//     dataSet3.addEventListener('click', handleDataSetClick('referals'));
//     dataSet4.addEventListener('click', handleDataSetClick('transactions'));

//     function setDataset(dataset) {
//         const labels = dataset.map(data => data.created_at);
//         const data = dataset.map(data => parseInt(data.sum))

//         myChart.data.labels = labels;
//         myChart.data.datasets[0].data = data;
//         myChart.update();
//         // return { labels, data };
//     }



//     // Календарь для графика
//     let chartCalendar = flatpickr("#calendar-chart", {
//         "mode": "range",
//         "locale": "ru",
//         defaultDate: [new Date().fp_incr(-14), new Date().fp_incr(-1)], // Дата по умолчанию предыдущие 2 недели
//         dateFormat: dateFormat, // Формат даты

//         onChange: function (selectedDates) {
//             updateChartData(selectedDates)
//         },
//         onReady: function (selectedDates) {
//             updateChartData(selectedDates)
//         },
//     });

//     // Функция для обновления данных графика

//     function updateChartData(selectedDates) {
//         let startDate = "";
//         let endDate = "";

//         if (selectedDates.length === 2) {
//             startDate = formatDate(selectedDates[0], dateFormat);
//             endDate = formatDate(selectedDates[1], dateFormat);
//         } else if (selectedDates.length === 1) {
//             // Если выбрана только 1 дата, а не диапазон
//             startDate = formatDate(selectedDates[0], dateFormat);
//             endDate = formatDate(selectedDates[0], dateFormat); // Используем одну и ту же дату для начала и конца диапазона
//         }
//         // Фильтруем данные графика в соответствии с выбранным диапазоном
//         const filteredDetaliedData = detailedDatabase.find((element) => {
//             return element.ref_link_id === currentId;
//         });

//         const filteredData = dataSet1.filter(data => {
//             const date = new Date(data.created_at);
//             const startDateObj = new Date(startDate);
//             const endDateObj = new Date(endDate);
//             return date >= startDateObj && date <= endDateObj;
//         });

//         // Обновляем данные графика
//         myChart.data.labels = filteredData.map(data => data.created_at);
//         myChart.data.datasets[0].data = filteredData.map(data => parseInt(data.sum));

//         // Обновляем график
//         myChart.update();
//     }
// })