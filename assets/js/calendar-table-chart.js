const dataTable = [
    {
        created_at: "2024-03-02 16:49:00",
        name: "08474",
        ref_link: "https:\/\/szmarket.ru\/r\/08474",
        ref_link_id: '1',
        all_clicks: 2,
        all_members: 1,
        all_transactions: 0,
        all_transactions_sum: 0
    },
    {
        created_at: "2024-03-04 16:22:55",
        name: "7df5c27f2e",
        ref_link: "https:\/\/szmarket.ru\/r\/7df5c27f2e",
        ref_link_id: '122',
        all_clicks: 0,
        all_members: 0,
        all_transactions: 0,
        all_transactions_sum: 0
    },
    {
        created_at: "2024-03-08 16:25:10",
        name: "818ae98db2",
        ref_link: "https:\/\/szmarket.ru\/r\/818ae98db2",
        ref_link_id: '1211',
        all_clicks: 0,
        all_members: 0,
        all_transactions: 0,
        all_transactions_sum: 0
    },
    {
        created_at: "2024-03-11 16:30:00",
        name: "e8feeb9224",
        ref_link: "https:\/\/szmarket.ru\/r\/e8feeb9224",
        ref_link_id: '121',
        all_clicks: 0,
        all_members: 0,
        all_transactions: 0,
        all_transactions_sum: 0
    },
    {
        created_at: "2024-03-14 16:33:25",
        name: "474b749e50",
        ref_link: "https:\/\/szmarket.ru\/r\/474b749e50",
        ref_link_id: '12',
        all_clicks: 0,
        all_members: 0,
        all_transactions: 0,
        all_transactions_sum: 0
    },
]

const detailedDatabase = {
    "1": {
        dataComission: [
            {
                created_at: "2024-03-04",
                sum: "4",
            },
            {
                created_at: "2024-03-05",
                sum: "4",
            },
            {
                created_at: "2024-03-06",
                sum: "5",
            },
            {
                created_at: "2024-03-07",
                sum: "10",
            },
            {
                created_at: "2024-03-08",
                sum: "20",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "40",
            },
            {
                created_at: "2024-03-06",
                sum: "55",
            },
            {
                created_at: "2024-03-07",
                sum: "13",
            },
            {
                created_at: "2024-03-08",
                sum: "25",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "44",
            },
            {
                created_at: "2024-03-06",
                sum: "55",
            },
            {
                created_at: "2024-03-07",
                sum: "103",
            },
            {
                created_at: "2024-03-08",
                sum: "20",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "2",
            },
            {
                created_at: "2024-03-06",
                sum: "3",
            },
            {
                created_at: "2024-03-07",
                sum: "19",
            },
            {
                created_at: "2024-03-08",
                sum: "5",
            },
        ]
    },
    "12": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "6",
            },
            {
                created_at: "2024-03-06",
                sum: "3",
            },
            {
                created_at: "2024-03-07",
                sum: "4",
            },
            {
                created_at: "2024-03-08",
                sum: "21",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "75",
            },
            {
                created_at: "2024-03-06",
                sum: "75",
            },
            {
                created_at: "2024-03-07",
                sum: "34",
            },
            {
                created_at: "2024-03-08",
                sum: "73",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "25",
            },
            {
                created_at: "2024-03-06",
                sum: "86",
            },
            {
                created_at: "2024-03-07",
                sum: "64",
            },
            {
                created_at: "2024-03-08",
                sum: "35",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "9",
            },
            {
                created_at: "2024-03-06",
                sum: "5",
            },
            {
                created_at: "2024-03-07",
                sum: "7",
            },
            {
                created_at: "2024-03-08",
                sum: "4",
            },
        ]
    },
    "121": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "5",
            },
            {
                created_at: "2024-03-06",
                sum: "7",
            },
            {
                created_at: "2024-03-07",
                sum: "5",
            },
            {
                created_at: "2024-03-08",
                sum: "6",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "78",
            },
            {
                created_at: "2024-03-06",
                sum: "65",
            },
            {
                created_at: "2024-03-07",
                sum: "45",
            },
            {
                created_at: "2024-03-08",
                sum: "77",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "46",
            },
            {
                created_at: "2024-03-06",
                sum: "58",
            },
            {
                created_at: "2024-03-07",
                sum: "36",
            },
            {
                created_at: "2024-03-08",
                sum: "77",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "22",
            },
            {
                created_at: "2024-03-06",
                sum: "77",
            },
            {
                created_at: "2024-03-07",
                sum: "88",
            },
            {
                created_at: "2024-03-08",
                sum: "22",
            },
        ]
    },
    "1211": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "9",
            },
            {
                created_at: "2024-03-06",
                sum: "8",
            },
            {
                created_at: "2024-03-07",
                sum: "8",
            },
            {
                created_at: "2024-03-08",
                sum: "4",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "58",
            },
            {
                created_at: "2024-03-06",
                sum: "55",
            },
            {
                created_at: "2024-03-07",
                sum: "77",
            },
            {
                created_at: "2024-03-08",
                sum: "55",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "36",
            },
            {
                created_at: "2024-03-06",
                sum: "58",
            },
            {
                created_at: "2024-03-07",
                sum: "22",
            },
            {
                created_at: "2024-03-08",
                sum: "25",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "36",
            },
            {
                created_at: "2024-03-06",
                sum: "38",
            },
            {
                created_at: "2024-03-07",
                sum: "88",
            },
            {
                created_at: "2024-03-08",
                sum: "25",
            },
        ]
    },
    "122": {
        dataComission: [
            {
                created_at: "2024-03-05",
                sum: "5",
            },
            {
                created_at: "2024-03-06",
                sum: "9",
            },
            {
                created_at: "2024-03-07",
                sum: "3",
            },
            {
                created_at: "2024-03-08",
                sum: "5",
            },
        ],
        dataClicks: [
            {
                created_at: "2024-03-05",
                sum: "83",
            },
            {
                created_at: "2024-03-06",
                sum: "69",
            },
            {
                created_at: "2024-03-07",
                sum: "55",
            },
            {
                created_at: "2024-03-08",
                sum: "39",
            },
        ],
        dataReferals: [
            {
                created_at: "2024-03-05",
                sum: "38",
            },
            {
                created_at: "2024-03-06",
                sum: "29",
            },
            {
                created_at: "2024-03-07",
                sum: "39",
            },
            {
                created_at: "2024-03-08",
                sum: "29",
            },
        ],
        dataTransactions: [
            {
                created_at: "2024-03-05",
                sum: "25",
            },
            {
                created_at: "2024-03-06",
                sum: "35",
            },
            {
                created_at: "2024-03-07",
                sum: "36",
            },
            {
                created_at: "2024-03-08",
                sum: "85",
            },
        ]
    }
}

window.addEventListener("DOMContentLoaded", () => {
    // Формат даты - используется в календаре, в графике и таблице для отображения и фильтрации при изменении
    const dateFormat = "Y-m-d";
    // Значение даты по умолчанию при инициализации для календарей Таблицы и Графика
    const defaultTableDate = [formatDate(new Date(Math.min(...dataTable.map(item => new Date(item.created_at))))), new Date().fp_incr(-1)];

    const defaultChartDate = [formatDate(new Date(Math.min(...dataTable.map(item => new Date(item.created_at))))), new Date().fp_incr(-1)]

    // Эта функция нужна для форматирования диапазона дат перед передачей в таблицу и график - она унифицирует все значения дат 
    function formatDate(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // Функция вызова модалки редактирования 
    function showEditModal(element) {
        element.addEventListener('click', () => {
            console.log('Открываем модалку редактирования');
        })
    };

    // Получаем контейнер с графиком
    const graphContainer = document.getElementById('graph-container');
    // Получаем контейнер с таблицей
    const tableContainer = document.getElementById('statistics-table-container');
    // Получаем кнопку Назад у графика
    const graphBackBtn = document.getElementById('graph-back-btn');
    // Получаем контейнер для заголовка табилицы
    const graphTitle = document.getElementById('graph-title');
    // Получаем кнопки-табы
    const dataSet1 = document.getElementById("testData1");
    const tabDataSum1 = document.getElementById('dataSum-1');
    const dataSet2 = document.getElementById("testData2");
    const tabDataSum2 = document.getElementById('dataSum-2');
    const dataSet3 = document.getElementById("testData3");
    const tabDataSum3 = document.getElementById('dataSum-3');
    const dataSet4 = document.getElementById("testData4");
    const tabDataSum4 = document.getElementById('dataSum-4');

    // Ф-ция суммирования значений Детальных данных для вывода в табы
    function getTotalDetailedSum(array) {
        return array.reduce((accumulator, currentValue) => {
            let numericValue = parseFloat(currentValue.sum); // Преобразование строки в число
            if (!isNaN(numericValue)) { // Проверка на успешное преобразование
                accumulator += numericValue;
            }
            return accumulator;
        }, 0);
    }


    function showGraph(element, link_id, link) {
        element.addEventListener('click', () => {
            graphContainer.style.display = "flex";
            tableContainer.style.display = "none";

            graphBackBtn.addEventListener('click', () => {
                graphContainer.style.display = "none";
                tableContainer.style.display = "block";
            })

            // Получаем и вставляем суммарные данные в табы графика
            tabDataSum1.innerHTML = getTotalDetailedSum(detailedDatabase[link_id].dataComission);
            tabDataSum2.innerHTML = getTotalDetailedSum(detailedDatabase[link_id].dataClicks);
            tabDataSum3.innerHTML = getTotalDetailedSum(detailedDatabase[link_id].dataReferals);
            tabDataSum4.innerHTML = getTotalDetailedSum(detailedDatabase[link_id].dataTransactions);

            // Устанавливаем ссылку в заголовок таблицы
            graphTitle.innerHTML = element.getAttribute("data-link");

            // Добавляем в табы дата атрибут с ключом 
            dataSet1.setAttribute("data-current-link_id", link_id);
            dataSet2.setAttribute("data-current-link_id", link_id);
            dataSet3.setAttribute("data-current-link_id", link_id);
            dataSet4.setAttribute("data-current-link_id", link_id);

            // Отрисовка графика при открытии блок по клику на Подробнее в таблице
            setDataset(detailedDatabase[link_id].dataComission)
            dataSet1.classList.add('active')
            dataSet2.classList.remove('active');
            dataSet3.classList.remove('active');
            dataSet4.classList.remove('active');
        })
    }

    function toggleActiveClass(event) {
        // Получаем элемент, на котором произошло событие клика
        const clickedElement = event.target;

        // Получаем все кнопки в массиве
        const buttons = [dataSet1, dataSet2, dataSet3, dataSet4];

        // Проходимся по всем кнопкам
        buttons.forEach(button => {
            // Если текущая кнопка совпадает с кнопкой, на которую кликнули
            if (button === clickedElement) {
                // Добавляем класс "active"
                button.classList.add("active");
            } else {
                // Иначе удаляем класс "active"
                button.classList.remove("active");
            }
        });
    }


    // Функция копирования данных
    // Копирование - Это дублирующий функционал (он ещё встречается в промокодах на страницах игр) 
    let activeCopyIcon;
    function copyData(element) {
        element.addEventListener('click', () => {
            navigator.clipboard.writeText(element.parentNode.parentNode.childNodes[0].textContent).then(
                element.innerHTML = "В буфере!"
            );
        });

        const onChangeActiveIcon = (item) => {
            if (activeCopyIcon) {
                activeCopyIcon.innerHTML = "Скопировать";
            }
            activeCopyIcon = item;
            item.innerHTML = "В буфере!";
        }

        element.addEventListener('click', ({ currentTarget }) => {
            onChangeActiveIcon(currentTarget);
        })
    }

    // Получение данных для таблицы и создание строк
    // Получаем ссылку на тело таблицы
    const tableBody = document.querySelector("#dataTable tbody");

    // Формирование строк таблицы из массива dataTable
    dataTable.forEach(data => {
        // Строка таблицы
        const row = document.createElement("tr");

        for (const prop in data) {
            // Создаем ячейки по условию, чтобы не выводить какой-то параметр
            if (prop !== "ref_link_id") {
                const cell = document.createElement("td");
                cell.textContent = data[prop];

                // Логика для ячейки ref_link
                if (prop === "ref_link") {
                    cell.classList.add("link")
                    const cellControllers = document.createElement('div');
                    cellControllers.classList.add("controllers", "edit", "copy", "detail");

                    // Оборачиваем ссылку в span, назначаем ему id
                    cell.textContent = "";
                    const linkElement = document.createElement("span");
                    linkElement.textContent = data[prop];
                    linkElement.setAttribute("id", `ref_link_${data.ref_link_id}`)
                    cell.appendChild(linkElement);

                    // Логика для кнопки "Скопировать"
                    const copyBtn = document.createElement("button");
                    copyBtn.classList.add("copy-btn");
                    copyBtn.innerHTML = "Скопировать";
                    cellControllers.appendChild(copyBtn);
                    copyData(copyBtn);

                    // Логика для кнопки "Редактировать"
                    const editBtn = document.createElement("button");
                    editBtn.classList.add("edit-btn");
                    editBtn.innerHTML = "Редактировать";
                    cellControllers.appendChild(editBtn);
                    showEditModal(editBtn);

                    // Логика для кнопки "Подробнее"
                    const detailBtn = document.createElement("button");
                    detailBtn.classList.add("detail-btn");
                    detailBtn.setAttribute("data-link-id", data.ref_link_id)
                    detailBtn.setAttribute("data-link", data.ref_link)
                    detailBtn.innerHTML = "Подробнее";
                    cellControllers.appendChild(detailBtn);
                    showGraph(detailBtn, data.ref_link_id, data.ref_link);

                    cell.appendChild(cellControllers);
                }

                // Задаем id ячейке столбца Имя
                if (prop === "name") {
                    cell.setAttribute("id", `name_${data.ref_link_id}`)
                }

                row.appendChild(cell);
            }
        }

        // Пушим строку в тело таблицы
        tableBody.appendChild(row);
    });


    let table = new DataTable('#dataTable', {
        info: false,
        autoWidth: true,
        scrollX: true,
        // Оставлю здесь, чтобы не потерять - для работы с сервером - https://datatables.net/reference/option/serverSide
        // Сама дока опций библиотеки https://datatables.net/reference/option/

        language: {
            "decimal": "",
            "emptyTable": "Нет данных",
            "thousands": ",",
            "lengthMenu": "Строк на странице _MENU_",
            "loadingRecords": "Загрузка...",
            "processing": "",
            "search": "Поиск:",
            "zeroRecords": "Нет данных, удовлетворяющих указанным параметрам",
            "paginate": {
                "first": "Первая",
                "last": "Последняя",
                "next": "Следующая",
                "previous": "Предыдущая"
            },
            "aria": {
                "orderable": "Упорядочить",
                "orderableReverse": "В обратном порядке"
            }
        },
        layout: {
            topEnd: {
                search: {
                    placeholder: 'Поиск по ссылке',
                    className: "test"
                }
            }
        },
        // initComplete: function () {
        // На случай, если понадобитсья добавлять класс к элементам таблицы
        //     const tableSearchInput = document.querySelector('#dataTable_wrapper #dt-search-0');
        //     tableSearchInput.classList.add('general-input');
        // },
    });

    function filterTableByCalendar(selectedDates) {
        let startDate = "";
        let endDate = "";

        if (selectedDates.length === 2) {
            startDate = formatDate(selectedDates[0], dateFormat);
            endDate = formatDate(selectedDates[1], dateFormat);
        } else if (selectedDates.length === 1) {
            // если выбрана только 1 дата, а не диапазон
            startDate = endDate = formatDate(selectedDates[0], dateFormat);
        }

        // console.log("Выбранный диапазон дат: ", startDate, " — ", endDate);

        table.column(0).search(function (value, index, data) {
            const date = new Date(value.split(' ')[0]);
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            return date >= startDateObj && date <= endDateObj;
        }).draw();
    }

    let tableCalendar = flatpickr("#calendar-1", {
        "mode": "range",
        "locale": "ru",
        defaultDate: defaultTableDate, // Дата по умолчанию предыдущие 2 недели
        dateFormat: dateFormat, // Формат даты
        onChange: function (selectedDates) {
            filterTableByCalendar(selectedDates);
        },
        onReady: function (selectedDates) {
            filterTableByCalendar(selectedDates);
        },
    });

    // Календарь для графика
    let chartCalendar = flatpickr("#calendar-chart", {
        "mode": "range",
        "locale": "ru",
        defaultDate: defaultChartDate, // Дата по умолчанию предыдущие 2 недели
        dateFormat: dateFormat, // Формат даты

        onChange: function (selectedDates) {
            const currentId = dataSet1.getAttribute("data-current-link_id");
            const activeDataType = document.querySelector(".cabinet-statistics-graph__tab.active").getAttribute("data-type");
            updateChartData(selectedDates, currentId, activeDataType)
        },
        onReady: function (selectedDates) {
            const currentId = dataSet1.getAttribute("data-current-link_id");
            const activeDataType = document.querySelector(".cabinet-statistics-graph__tab.active").getAttribute("data-type");
            updateChartData(selectedDates, currentId, activeDataType)
        },
    });
    // График
    // Инициализация

    const plugin = {
        id: 'customCanvasBackgroundColor',
        beforeDraw: (chart, args, options) => {
            const { ctx } = chart;
            ctx.save();
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = options.color || '#99ffff';
            ctx.fillRect(0, 0, chart.width, chart.height);
            ctx.restore();
        }
    };

    let myChart;
    const ctx = document.getElementById('myChart').getContext('2d');
    myChart = new Chart(ctx, {
        type: 'line',
        title: 'test',
        data: {
            labels: [],
            datasets: [{
                label: 'Сумма',
                data: [],
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 2,
                borderColor: "#008d26",
            }]
        },
        options: {
            legend: false,
            scales: {
                x: {
                    offset: true
                },
                y: {
                    beginAtZero: true
                }
            },
            elements: {
                line: {
                    // Кривизна графика, если не нужна удалить line или скорректировать tension
                    tension: 0.3
                }
            },
            plugins: {
                customCanvasBackgroundColor: {
                    color: '#e9e9e9',
                },
            }
        },
        plugins: [plugin]
    });

    // // Помещаем данные из выбранного датасета
    function handleDataSetClick(dataType) {
        return ({ currentTarget }) => {
            const currentId = currentTarget.getAttribute("data-current-link_id");
            switch (dataType) {
                case 'comission':
                    setDataset(detailedDatabase[currentId].dataComission);
                    break;
                case 'clicks':
                    setDataset(detailedDatabase[currentId].dataClicks);
                    break;
                case 'referals':
                    setDataset(detailedDatabase[currentId].dataReferals);
                    break;
                case 'transactions':
                    setDataset(detailedDatabase[currentId].dataTransactions);
                    break;
                default:
                    console.error("Неверный тип данных");
            }
        };
    }

    // 04/04 Добавил перенос даты, между графиками
    dataSet1.addEventListener('click', (event) => {
        toggleActiveClass(event);
        handleDataSetClick('comission')(event);
        // updateChartData(chartCalendar.selectedDates, event.target.getAttribute('data-current-link_id'), event.target.getAttribute('data-type'));
    });
    dataSet2.addEventListener('click', (event) => {
        toggleActiveClass(event);
        handleDataSetClick('clicks')(event);
        // updateChartData(chartCalendar.selectedDates, event.target.getAttribute('data-current-link_id'), event.target.getAttribute('data-type'));
    });
    dataSet3.addEventListener('click', (event) => {
        toggleActiveClass(event);
        handleDataSetClick('referals')(event);
        // updateChartData(chartCalendar.selectedDates, event.target.getAttribute('data-current-link_id'), event.target.getAttribute('data-type'));
    });
    dataSet4.addEventListener('click', (event) => {
        toggleActiveClass(event);
        handleDataSetClick('transactions')(event);
        // updateChartData(chartCalendar.selectedDates, event.target.getAttribute('data-current-link_id'), event.target.getAttribute('data-type'));
    });

    function setDataset(dataset) {
        const labels = dataset.map(data => data.created_at);
        const data = dataset.map(data => parseInt(data.sum))

        myChart.data.labels = labels;
        myChart.data.datasets[0].data = data;
        myChart.update();
    }

    // Функция для обновления данных графика
    function updateChartData(selectedDates, currentId, dataType) {
        let startDate = "";
        let endDate = "";
        console.log(selectedDates);
        if (selectedDates.length === 2) {
            startDate = formatDate(selectedDates[0], dateFormat);
            endDate = formatDate(selectedDates[1], dateFormat);
        } else if (selectedDates.length === 1) {
            // Если выбрана только 1 дата, а не диапазон
            startDate = formatDate(selectedDates[0], dateFormat);
            endDate = formatDate(selectedDates[0], dateFormat); // Используем одну и ту же дату для начала и конца диапазона
        }

        // myChart.update();
        // Фильтруем данные для текущего типа информации
        const filteredData = detailedDatabase[currentId][dataType].filter(data => {
            const date = new Date(data.created_at);
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            return date >= startDateObj && date <= endDateObj;
        });

        myChart.data.labels = filteredData.map(data => data.created_at);
        myChart.data.datasets[0].data = filteredData.map(data => parseInt(data.sum));

        myChart.update();
    }
})